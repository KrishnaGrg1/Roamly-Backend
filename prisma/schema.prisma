// ===================================
// Prisma Generator & Datasource
// ===================================

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===================================
// ENUMS
// ===================================

enum LocationCategory {
  HOTEL
  RESTAURANT
  ATTRACTION
  TREKKING
  VIEWPOINT
  SHOPPING
  OTHER
}

enum UserRole {
  USER
  BUSINESS
  ADMIN
}

enum SubscriptionTier {
  FREE
  PREMIUM
}

enum MediaType {
  PHOTO
  VIDEO
}

enum BusinessType {
  HOTEL
  RESTAURANT
  GUIDE
  EXPERIENCE
  SHOP
}

enum BusinessTier {
  FREE
  BOOSTED
  PREMIUM
}

enum TripStatus {
  GENERATED
  SAVED
  COMPLETED
  CANCELLED
}

enum TravelStyle {
  ADVENTURE
  RELAXED
  CULTURAL
  LUXURY
  BACKPACKING
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
}
enum BusinessStatus {
  DRAFT
  PENDING
  ACTIVE
  SUSPENDED
}

// ===================================
// USER
// ===================================

model User {
  id       String   @id @default(uuid())
  name     String
  email    String   @unique
  password String
  avatar   String?
  role     UserRole @default(USER)

  subscriptionTier SubscriptionTier @default(FREE)
  subscriptionEnds DateTime?

  preferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts         Post[]
  bookmarks     Bookmark[]
  reviews       Review[]
  travelHistory TravelHistory[]
  comments      Comment[]
  likes         Like[]
  routes        Route[]
  trips         Trip[]
  businesses    Business[]
  bookings      Booking[]
  aiLogs        AiInteraction[]
  refreshTokens RefreshToken[]
}

// ===================================
// REFRESH TOKENS
// ===================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}


// ===================================
// POSTS & SOCIAL
// ===================================

model Post {
  id         String    @id @default(uuid())
  userId     String
  caption    String?
  mediaUrl   String
  mediaType  MediaType
  locationId String?
  createdAt  DateTime  @default(now())

  user      User       @relation(fields: [userId], references: [id])
  location  Location?  @relation(fields: [locationId], references: [id])
  comments  Comment[]
  likes     Like[]
  bookmarks Bookmark[]

  @@index([createdAt])
  @@index([locationId])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])
  user User @relation(fields: [userId], references: [id])
}

model Like {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
}

model Bookmark {
  id         String   @id @default(uuid())
  userId     String
  postId     String?
  locationId String?
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id])
  post     Post?     @relation(fields: [postId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])
}

// ===================================
// LOCATION & BUSINESS
// ===================================

model Location {
  id          String           @id @default(uuid())
  name        String
  category    LocationCategory
  description String?
  latitude    Float
  longitude   Float
  address     String?

  priceRange String?
  avgRating  Float?
  verified   Boolean @default(false)

  ownerBusinessId String?
  ownerBusiness   Business? @relation(fields: [ownerBusinessId], references: [id])

  createdAt DateTime @default(now())

  posts      Post[]
  reviews    Review[]
  embeddings LocationEmbedding?
  bookmarks  Bookmark[]
  promotions Promotion[]
  bookings   Booking[]

  @@index([latitude, longitude])
  @@index([category])
}

model Business {
  id        String       @id @default(uuid())
  ownerId   String
  type      BusinessType
  tier      BusinessTier @default(FREE)
  verified  Boolean      @default(false)
  status    BusinessStatus @default(DRAFT)

  owner     User       @relation(fields: [ownerId], references: [id])
  profile   BusinessProfile?
  locations Location[]
  bookings  Booking[]

  createdAt DateTime @default(now())
}
model BusinessProfile {
  id             String @id @default(uuid())
  businessId     String @unique

  name           String
  description    String?
  establishedAt  Int?
  website        String?
  phone          String?
  email          String?
  logoUrl        String?

  business       Business @relation(fields: [businessId], references: [id])
}

// ===================================
// REVIEWS & PROMOTION
// ===================================

model Review {
  id         String   @id @default(uuid())
  userId     String
  locationId String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  location Location @relation(fields: [locationId], references: [id])

  @@unique([userId, locationId])
}

model Promotion {
  id          String   @id @default(uuid())
  locationId  String
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())

  location Location @relation(fields: [locationId], references: [id])
}

// ===================================
// AI & EMBEDDINGS
// ===================================

model LocationEmbedding {
  id         String  @id @default(uuid())
  locationId String  @unique
  embedding  Float[]
  metadata   Json?

  location Location @relation(fields: [locationId], references: [id])
}

model AiInteraction {
  id       String @id @default(uuid())
  userId   String
  prompt   String
  response Json
  model    String
  tokens   Int?
  feedback Int?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ===================================
// TRIPS & ROUTES
// ===================================

model Trip {
  id     String     @id @default(uuid())
  userId String
  status TripStatus @default(GENERATED)

  startLocation String
  days          Int
  budget        String
  travelStyle   TravelStyle[]

  itinerary     Json
  costBreakdown Json?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Route {
  id          String   @id @default(uuid())
  userId      String
  sourceLat   Float
  sourceLng   Float
  destLat     Float
  destLng     Float
  distanceKm  Float?
  durationMin Float?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model TravelHistory {
  id          String   @id @default(uuid())
  userId      String
  source      String
  destination String
  date        DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ===================================
// BOOKINGS & PAYMENTS
// ===================================

model Booking {
  id         String @id @default(uuid())
  userId     String
  businessId String
  locationId String

  amount     Float
  commission Float
  status     BookingStatus

  createdAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  location Location @relation(fields: [locationId], references: [id])

  @@index([userId])
  @@index([businessId])
}
