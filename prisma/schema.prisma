// ===================================
// Prisma Generator & Datasource
// ===================================

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ===================================
// ENUMS
// ===================================

enum LocationCategory {
  HOTEL
  RESTAURANT
  ATTRACTION
  TREKKING
  VIEWPOINT
  SHOPPING
  OTHER
}

enum UserRole {
  USER
  BUSINESS
  ADMIN
}

enum SubscriptionTier {
  FREE
  PREMIUM
}

enum MediaType {
  PHOTO
  VIDEO
}

enum BusinessType {
  HOTEL
  RESTAURANT
  GUIDE
  EXPERIENCE
  SHOP
}

enum BusinessTier {
  FREE
  BOOSTED
  PREMIUM
}

enum TripStatus {
  GENERATED
  SAVED
  COMPLETED
  CANCELLED
}

enum TravelStyle {
  ADVENTURE
  RELAXED
  CULTURAL
  LUXURY
  BACKPACKING
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
}
enum BusinessStatus {
  DRAFT
  PENDING
  ACTIVE
  SUSPENDED
}

// ===================================
// USER
// ===================================

model User {
  id       String   @id @default(uuid())
  name     String
  email    String   @unique
  password String
  avatar   String?
  role     UserRole @default(USER)

  subscriptionTier SubscriptionTier @default(FREE)
  subscriptionEnds DateTime?

  preferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts         Post[]
  bookmarks     Bookmark[]
  reviews       Review[]
  comments      Comment[]
  likes         Like[]
  trips         Trip[]
  businesses    Business[]
  bookings      Booking[]
  aiLogs        AiInteraction[]
  refreshTokens RefreshToken[]
  chatSessions  AIChatSession[]
}

// ===================================
// REFRESH TOKENS
// ===================================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}


// ===================================
// POSTS & SOCIAL
// ===================================

model Post {
  id        String   @id @default(uuid())
  userId    String
  tripId    String   @unique
  caption   String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  trip Trip @relation(fields: [tripId], references: [id])

  comments  Comment[]
  likes     Like[]
  bookmarks Bookmark[]

  @@index([createdAt])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])
  user User @relation(fields: [userId], references: [id])
}

model Like {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
}

model Bookmark {
  id         String   @id @default(uuid())
  userId     String
  postId     String?
  locationId String?
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id])
  post     Post?     @relation(fields: [postId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])
}

// ===================================
// LOCATION & BUSINESS
// ===================================

model Location {
  id            String           @id @default(uuid())
  googlePlaceId String?          @unique
  name          String
  category      LocationCategory
  description   String?
  latitude      Float
  longitude     Float
  address       String?

  priceRange String?
  avgRating  Float?
  verified   Boolean @default(false)

  ownerBusinessId String?
  ownerBusiness   Business? @relation(fields: [ownerBusinessId], references: [id])

  createdAt DateTime @default(now())

  reviews    Review[]
  embeddings LocationEmbedding?
  bookmarks  Bookmark[]
  promotions Promotion[]
  bookings   Booking[]

  @@index([latitude, longitude])
  @@index([category])
}

model Business {
  id        String       @id @default(uuid())
  ownerId   String
  type      BusinessType
  tier      BusinessTier @default(FREE)
  verified  Boolean      @default(false)
  status    BusinessStatus @default(DRAFT)

  owner     User       @relation(fields: [ownerId], references: [id])
  profile   BusinessProfile?
  locations Location[]
  bookings  Booking[]

  createdAt DateTime @default(now())
}
model BusinessProfile {
  id             String @id @default(uuid())
  businessId     String @unique

  name           String
  description    String?
  establishedAt  Int?
  website        String?
  phone          String?
  email          String?
  logoUrl        String?

  business       Business @relation(fields: [businessId], references: [id])
}

// ===================================
// REVIEWS & PROMOTION
// ===================================

model Review {
  id         String   @id @default(uuid())
  userId     String
  locationId String
  tripId     String?
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  location Location @relation(fields: [locationId], references: [id])

  @@unique([userId, locationId])
}

model Promotion {
  id          String   @id @default(uuid())
  locationId  String
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())

  location Location @relation(fields: [locationId], references: [id])
}

// ===================================
// AI & EMBEDDINGS
// ===================================

model LocationEmbedding {
  id         String  @id @default(uuid())
  locationId String  @unique
  embedding  Float[]
  metadata   Json?

  location Location @relation(fields: [locationId], references: [id])
}

model AiInteraction {
  id       String  @id @default(uuid())
  userId   String
  tripId   String?
  purpose  String
  prompt   String?
  response Json?
  model    String
  tokens   Int?
  cost     Float?

  createdAt DateTime @default(now())

  user User  @relation(fields: [userId], references: [id])
  trip Trip? @relation(fields: [tripId], references: [id])
}

// ===================================
// AI CHAT SYSTEM
// ===================================

enum ChatIntent {
  PLAN
  MODIFY
  COMPARE
  RECALL
  EXPLORE
  GENERAL
}

enum ChatMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

model AIChatSession {
  id        String   @id @default(uuid())
  userId    String
  title     String?
  intent    ChatIntent?
  active    Boolean  @default(true)
  
  messageCount Int @default(0)
  tokenCount   Int @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user     User              @relation(fields: [userId], references: [id])
  messages AIChatMessage[]
  
  @@index([userId, active])
}

model AIChatMessage {
  id        String          @id @default(uuid())
  sessionId String
  role      ChatMessageRole
  content   String
  tokens    Int?
  
  createdAt DateTime @default(now())
  
  session    AIChatSession        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  references AIContextReference[]
  
  @@index([sessionId])
}

model AIContextReference {
  id        String  @id @default(uuid())
  messageId String
  
  refType   String // "TRIP", "POST", "LOCATION", "REVIEW"
  refId     String
  
  message AIChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
}

// ===================================
// TRIPS & ROUTES
// ===================================

model Trip {
  id        String     @id @default(uuid())
  userId    String
  status    TripStatus @default(GENERATED)

  title       String?
  source      String
  destination String
  days        Int
  budgetMin   Float?
  budgetMax   Float?

  travelStyle TravelStyle[]

  itinerary     Json
  costBreakdown Json?

  aiModel   String?
  aiVersion String?

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  user         User            @relation(fields: [userId], references: [id])
  post         Post?
  aiLogs       AiInteraction[]
}

// ===================================
// BOOKINGS & PAYMENTS
// ===================================

model Booking {
  id         String @id @default(uuid())
  userId     String
  businessId String
  locationId String

  amount     Float
  commission Float
  status     BookingStatus

  createdAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  business Business @relation(fields: [businessId], references: [id])
  location Location @relation(fields: [locationId], references: [id])

  @@index([userId])
  @@index([businessId])
}
